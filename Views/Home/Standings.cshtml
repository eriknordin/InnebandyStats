@model InnebandyStats.Models.CompetitionViewModel
@{
    ViewData["Title"] = Model.CompetitionName;
}

@functions {
    string SortUrl(string column)
    {
        var newDesc = Model.SortBy == column ? !Model.SortDesc : true;
        var routeValues = new Dictionary<string, string?>
        {
            ["id"] = Model.CompetitionId.ToString(),
            ["sort"] = column,
            ["desc"] = newDesc.ToString().ToLower()
        };
        if (!string.IsNullOrEmpty(Model.FilterTeam)) routeValues["team"] = Model.FilterTeam;
        if (Model.FilterAge.HasValue) routeValues["age"] = Model.FilterAge.Value.ToString();
        if (Model.FilterBirthYear.HasValue) routeValues["birthyear"] = Model.FilterBirthYear.Value.ToString();
        return Url.Action("Standings", "Home", routeValues)!;
    }

    string SortIndicator(string column)
    {
        if (Model.SortBy != column) return "";
        return Model.SortDesc ? " ‚ñº" : " ‚ñ≤";
    }
}

<div class="standings-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-2">@Model.CompetitionName</h1>
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                ‚Üê Ny s√∂kning
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">
            <strong>‚ö†Ô∏è Fel:</strong> @Model.ErrorMessage
        </div>
    }

    @if (Model.Standings != null)
    {
        <div class="filters-card mb-4">
            <h5 class="mb-3">üîç Filtrera statistik</h5>
            <form method="get" asp-action="Standings">
                <input type="hidden" name="id" value="@Model.CompetitionId" />
                <input type="hidden" name="sort" value="@Model.SortBy" />
                <input type="hidden" name="desc" value="@Model.SortDesc.ToString().ToLower()" />

                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="team" class="form-label">Lag</label>
                        <select name="team" id="team" class="form-select">
                            <option value="">Alla lag</option>
                            @foreach (var t in Model.AvailableTeams)
                            {
                                <option value="@t" selected="@(Model.FilterTeam == t)">@t</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="age" class="form-label">√Ölder</label>
                        <select name="age" id="age" class="form-select">
                            <option value="">Alla √•ldrar</option>
                            @foreach (var a in Model.AvailableAges)
                            {
                                <option value="@a" selected="@(Model.FilterAge == a)">@a √•r</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="birthyear" class="form-label">F√∂delse√•r</label>
                        <select name="birthyear" id="birthyear" class="form-select">
                            <option value="">Alla f√∂delse√•r</option>
                            @foreach (var y in Model.AvailableBirthYears)
                            {
                                <option value="@y" selected="@(Model.FilterBirthYear == y)">@y</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">Till√§mpa filter</button>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.FilterTeam) || Model.FilterAge.HasValue || Model.FilterBirthYear.HasValue)
                    {
                        <div class="col-md-2">
                            <a asp-action="Standings" asp-route-id="@Model.CompetitionId"
                               class="btn btn-outline-secondary w-100">Rensa</a>
                        </div>
                    }
                </div>
            </form>
        </div>

        <div class="stats-summary mb-3">
            <span class="badge bg-info text-dark">üë• @Model.Standings.Count spelare</span>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="rank-col">#</th>
                        <th><a href="@SortUrl("name")">Namn@(SortIndicator("name"))</a></th>
                        <th class="text-center"><a href="@SortUrl("age")">√Ölder@(SortIndicator("age"))</a></th>
                        <th class="text-center"><a href="@SortUrl("birthyear")">F√∂dd@(SortIndicator("birthyear"))</a></th>
                        <th><a href="@SortUrl("team")">Lag@(SortIndicator("team"))</a></th>
                        <th class="text-center"><a href="@SortUrl("matches")">M@(SortIndicator("matches"))</a></th>
                        <th class="text-center"><a href="@SortUrl("goals")">M√•l@(SortIndicator("goals"))</a></th>
                        <th class="text-center"><a href="@SortUrl("assists")">A@(SortIndicator("assists"))</a></th>
                        <th class="text-center"><a href="@SortUrl("points")">P@(SortIndicator("points"))</a></th>
                        <th class="text-center"><a href="@SortUrl("ppg")">P/M@(SortIndicator("ppg"))</a></th>
                        <th class="text-center"><a href="@SortUrl("penalty")">Utv@(SortIndicator("penalty"))</a></th>
                    </tr>
                </thead>
                <tbody>
                    @{ var rank = 1; }
                    @foreach (var player in Model.Standings)
                    {
                        <tr class="@(rank <= 3 ? "top-player top-" + rank : "")">
                            <td class="rank-col">
                                @if (rank == 1)
                                {
                                    <span class="rank-badge gold">ü•á</span>
                                }
                                else if (rank == 2)
                                {
                                    <span class="rank-badge silver">ü•à</span>
                                }
                                else if (rank == 3)
                                {
                                    <span class="rank-badge bronze">ü•â</span>
                                }
                                else
                                {
                                    <span>@rank</span>
                                }
                            </td>
                            <td><strong>@player.Name</strong></td>
                            <td class="text-center">@player.Age</td>
                            <td class="text-center">@player.BirthYear</td>
                            <td>@player.Team</td>
                            <td class="text-center">@player.Matches</td>
                            <td class="text-center"><span class="stat-badge goals">@player.Goals</span></td>
                            <td class="text-center"><span class="stat-badge assists">@player.Assists</span></td>
                            <td class="text-center"><strong class="stat-badge points">@player.Points</strong></td>
                            <td class="text-center">@player.PointsPerGame.ToString("0.00")</td>
                            <td class="text-center">@(player.PenaltyMinutes > 0 ? player.PenaltyMinutes.ToString() : "-")</td>
                        </tr>
                        rank++;
                    }
                </tbody>
            </table>
        </div>
    }
</div>
